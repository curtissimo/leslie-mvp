<!DOCTYPE html>

<html>
<head>
  <title>leslie.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>leslie.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2014 by curtissimo, llc</p>
<p>Licensed under the MIT license, a copy of which you can find in the
distribution in the LICENSE file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/*jslint node: true*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Declare and initialize module-level variables.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cwd, fs, leslie, proto, path, rsvp, scene, stat, util, url, modifyScene;

fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
rsvp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rsvp'</span>);
util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'utile'</span>);
url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>);

cwd = process.cwd();
stat = rsvp.denodeify(fs.stat);
modifyScene = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{ <span class="hljs-string">'use strict'</span>; <span class="hljs-keyword">return</span> o; };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Define an utility funciton that takes a code and an error to normalize for
use in the HTTP-handling stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">codeError</span><span class="hljs-params">(code, error)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> error === <span class="hljs-string">'string'</span>) {
    error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(error);
  } <span class="hljs-keyword">else</span> {
    error = error || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>();
  }
  <span class="hljs-keyword">if</span> (error.statusCode === <span class="hljs-literal">undefined</span>) {
    error.statusCode = code;
  }
  <span class="hljs-keyword">return</span> error;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Define a utility function that takes a <em>directive</em> in the form
“presenter#verb” and a <em>format</em> that provides translation from directive to
some other format.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDirective</span><span class="hljs-params">(directive, format)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">var</span> args, name, verb, formattedFile, formattedPath, count;

  count = format.match(<span class="hljs-regexp">/%s/g</span>).length;
  name = directive.split(<span class="hljs-string">'#'</span>);
  verb = (name[<span class="hljs-number">1</span>] || <span class="hljs-string">'get'</span>).toLowerCase();
  name = name[<span class="hljs-number">0</span>];
  args = [ format, name ];
  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>) {
    args.push(verb);
  }
  formattedPath = util.format.apply(<span class="hljs-literal">null</span>, args);
  formattedFile = formattedPath + <span class="hljs-string">'.js'</span>;

  <span class="hljs-keyword">return</span> {
    name: name,
    formattedFile: formattedFile,
    formattedPath: formattedPath,
    verb: verb
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1 id="scenes">Scenes</h1>
<p>Scenes represent the common interface in <strong>leslie</strong> to the request and
response of the lifecycle of user interaction over HTTP. We shamelessly stole
the idea from <a href="https://developer.yahoo.com/cocktails/mojito/">Mojito’s</a> idea
of the <a href="https://developer.yahoo.com/cocktails/mojito/api/classes/ActionContext.html"><code>ActionContext</code></a>.
<strong>leslie</strong>‘s scene (we hope) provides an easier-to-use interface.</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="creating-scenes">Creating scenes</h2>
<p>First up, declare a scene factory to generate scenes for each HTTP request
based on the request, response, and global helpers registered with
<strong>leslie</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sceneFactory</span><span class="hljs-params">(req, res, helpers)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">var</span> viewData, o;
  o = {};
  viewData = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Each scene has access to the application’s settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(req.app.settings).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    o[key] = req.app.settings[key];
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Each scene has access to the list of globally-defined helpers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  o.helpers = helpers || [];</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Each scene has access to the request’s URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  o.url = url.parse(req.url);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Each scene can provide parameter lookup from the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  o.param = req.param.bind(req);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Each scene can provide access to the cookies sent on the response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  o.cookie = res.cookie.bind(res);
  o.clearCookie = res.clearCookie.bind(res);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Each scene allows for per-request registration of view data from which each
presenter can benefit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  o.addViewData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
    util.mixin(viewData, data);
  };
  o.mergeViewData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">var</span> key;
    <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> viewData) {
      <span class="hljs-keyword">if</span> (viewData.hasOwnProperty(key) &amp;&amp; data[key] === <span class="hljs-literal">undefined</span>) {
        data[key] = viewData[key];
      }
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>For each scene construction, pass it to a registered callback (if it
exists) for application-specific modifications.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> modifyScene === <span class="hljs-string">'function'</span>) {
    o = modifyScene(o, req) || o;
  }

  <span class="hljs-keyword">return</span> o;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="interacting-with-scenes">Interacting with scenes</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>leslie</strong> wraps a scene in a promise so that presenters can interact with
the scene using semantically rich methods as opposed to configuration blocks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scenePromise</span><span class="hljs-params">(scene, method)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> rsvp.Promise(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(res, rej)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>scene.stage</code> provides the presenter a method to arrange a view, some
data, and call other controllers to assemble a response.</p>
<ul>
<li>The <code>view</code> parameter allows the presenter to use a view named something
other than the name of the HTTP method used to resolve the call.</li>
<li>The <code>data</code> parameter contains an object with key-value pairs used in
the rendering of the view</li>
<li>The <code>controllers</code> parameter is a dictionary used to invoke other
presenter. The value is the name of the presenter and the key is the
name of the key to which <strong>leslie</strong> should bind the resolution of the
presenter’s render run.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scene.stage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(view, data, controllers)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> view !== <span class="hljs-string">'string'</span>) {
        controllers = data;
        data = view;
        view = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> scene.mergeViewData === <span class="hljs-string">'function'</span>) {
        data = data || {};
        scene.mergeViewData(data);
      }
      res({ view: view, data: data, controllers: controllers });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>scene.cut</code> indicates that the render should end and an error sent back
to the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scene.cut = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> </span>{
      rej(o);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>scene.block</code> provides the presenter with a way to indicate that it
should redirect to another URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scene.block = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(href)</span> </span>{
      rej(codeError(<span class="hljs-number">302</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(href)));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><code>scene.seen</code> provides the presenter with a way to indicate that its
content has not changed since the last request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scene.seen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      rej(codeError(<span class="hljs-number">304</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>()));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>scene.run</code> provides the presenter with a way to pipe a stream back to
the client.</p>
<ul>
<li><code>type</code> indicates the <code>Content-Type</code> of the reseponse.</li>
<li><code>pipe</code> contains the object that has a <code>pipe(OutputStream)</code> method on
 it to stream the content back to the client.</li>
<li><code>md5</code> contains an optional md5 hash of the content of the pipe.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    scene.run = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, pipe, md5)</span> </span>{
      res({ type: type, pipe: pipe, md5: md5 });
    };
    method(scene);
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h1 id="views">Views</h1>
<p>Views represent some package of JavaScript functionality that <strong>leslie</strong>
invokes to generate HTML for the client.</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="views-as-promises">Views as promises</h2>
<p><strong>leslie</strong> uses promises to find, load, and render views. This method creates
those promsises.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">viewPromise</span><span class="hljs-params">(directive, data, scene)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> rsvp.Promise(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(res, rej)</span> </span>{
    <span class="hljs-keyword">var</span> code, format, parts;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Find the path to the correct view module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    format = path.join(cwd, <span class="hljs-string">'lib'</span>, <span class="hljs-string">'%s'</span>, <span class="hljs-string">'views'</span>, <span class="hljs-string">'%s'</span>);
    parts = parseDirective(directive, format);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Prime the error code with “Not Found”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    code = <span class="hljs-number">404</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Ask that the file exists. If it does, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stat(parts.formattedFile)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>… then set the error code to “Internal Error” and laod the view
module. If that succeeds, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        code = <span class="hljs-number">500</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(parts.formattedPath);
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>… then get the key for the view and set the error code to “Not
Found”. If the key exists, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(catalog)</span> </span>{
        <span class="hljs-keyword">var</span> viewKey = path.relative(cwd, parts.formattedPath);
        code = <span class="hljs-number">404</span>;
        <span class="hljs-keyword">if</span> (catalog[viewKey] === <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'view '</span> + viewKey + <span class="hljs-string">' not in the view catalog'</span>);
        }
        <span class="hljs-keyword">return</span> catalog[viewKey];
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>… then set the error code to “Internal Error” and render the view. If
the view renders without error, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(view)</span> </span>{
        code = <span class="hljs-number">500</span>;
        <span class="hljs-keyword">return</span> view(data, {
          helpers: scene.helpers
        });
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>… then accept the promise with the generated HTML; otherwise, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(html)</span> </span>{
        res(html);
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>… for any error that occurred along the promise resolution pipeline,
reject the promise with an appropriately coded error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{
        rej(codeError(code, e));
      });
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h1 id="presenters">Presenters</h1>
<p>Presenters represent the coördinators of model and view. This is the P in
MVP.</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2 id="presenters-as-promises">Presenters as promises</h2>
<p><strong>leslie</strong> uses promsies to find and load presenter objects and coördinate
the invocation of the associated views. This method creates those promsises.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">controllerPromise</span><span class="hljs-params">(directive, scenes)</span> </span>{
<span class="hljs-pi">  'use strict'</span>;
  <span class="hljs-keyword">var</span> code, format, parts, scene, pipe;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Find the path to the correct presenter module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  format = path.join(cwd, <span class="hljs-string">'lib'</span>, <span class="hljs-string">'%s'</span>, <span class="hljs-string">'controller'</span>);
  parts = parseDirective(directive, format);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Generate a scene from the supplied scene factory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  scene = scenes();</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Prime the error code to “Not Found”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  code = <span class="hljs-number">404</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Default the request to a non-piped response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pipe = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> rsvp.Promise(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(res, rej)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Ask that the file exists. If it does, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stat(parts.formattedFile)</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>… then set the error code to “Internal Error” and laod the presenter
module. If that succeeds, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        code = <span class="hljs-number">500</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(parts.formattedPath);
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>… then get the key for the presenter’s method to invoke and set the
error code to “Not Found”. If the key exists, then return the method
for the verb and …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(controller)</span> </span>{
        code = <span class="hljs-number">404</span>;
        <span class="hljs-keyword">if</span> (controller[parts.verb] === <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'controller does not have verb '</span> + parts.verb);
        }
        <span class="hljs-keyword">return</span> controller[parts.verb];
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>… create a scene promise with the newly-created scene and the method
for the presenter. Set the error code to “Internal Error”. Return the
scene promise, …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method)</span> </span>{
        code = <span class="hljs-number">500</span>;
        <span class="hljs-keyword">return</span> scenePromise(scene, method);
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>… then collect the staged information from the scene:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(staging)</span> </span>{
        <span class="hljs-keyword">var</span> data, controllers;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <ul>
<li>If the response should be piped, return the piped object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (staging.pipe) {
          pipe = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">return</span> staging;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <ul>
<li>Normalize the view, data, and presenters from the scene.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scene.view = staging.view;
        data = staging.data;
        <span class="hljs-keyword">if</span> (data === <span class="hljs-literal">undefined</span>) {
          data = {};
        }
        controllers = staging.controllers || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li>For each dependent presenter, create a promise to invoke it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">Object</span>.keys(controllers).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
          <span class="hljs-keyword">var</span> value = controllers[key];

          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
            data[key] = controllerPromise(value, scenes);
          }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Return the data with any promised controllers rendered, as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> rsvp.hash(data);
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>With all of the rendered dependent views, return a view promise that
for the presenter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
        <span class="hljs-keyword">if</span> (pipe) {
          <span class="hljs-keyword">return</span> res(data);
        }
        <span class="hljs-keyword">if</span> (scene.view) {
          directive = [parts.name, scene.view].join(<span class="hljs-string">'#'</span>);
        }
        res(viewPromise(directive, data, scene));
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>For any error that occurred along the promise resolution pipeline,
reject the promise with an appropriately coded error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{
        rej(codeError(code, e));
      });
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h1 id="responding-to-http-requests">Responding to HTTP requests</h1>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Create the prototypical object used by <strong>leslie</strong> to route requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*jslint nomen: true*/</span>
proto = {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><code>leslie.addMinion</code> allows applications to register global view helpers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addMinion: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, helper)</span> </span>{
<span class="hljs-pi">    'use strict'</span>;
    <span class="hljs-keyword">this</span>.minions = <span class="hljs-keyword">this</span>.minions || {};
    <span class="hljs-keyword">this</span>.minions[name] = helper;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><code>leslie.setModifyScene</code> registers the application-specific callback invoked
by <strong>leslie</strong> for every scene creation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setModifyScene: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> </span>{
<span class="hljs-pi">    'use strict'</span>;
    modifyScene = fn;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><code>leslie.bother</code> returns an express-compatible method for handling requests.
It registers the method for the specific directive of format
“presenter#verb” for an express map registration. For example:</p>
<pre><code>express.get(<span class="hljs-string">'/actors'</span>, leslie.bother(<span class="hljs-string">'actors#get'</span>));
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  bother: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(directive)</span> </span>{
<span class="hljs-pi">    'use strict'</span>;
    <span class="hljs-keyword">var</span> self, controller;

    self = <span class="hljs-keyword">this</span>;
    directive = directive.split(<span class="hljs-string">'#'</span>);
    controller = directive[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span> </span>{
      <span class="hljs-keyword">var</span> scenes, minions, invocation, callMethod;

      callMethod = req.method.toLowerCase();
      minions = self.minions || {};
      scenes = sceneFactory.bind(<span class="hljs-literal">null</span>, req, res, minions);

      <span class="hljs-keyword">if</span> (req.body &amp;&amp; req.body.__method__) {
        callMethod = req.body.__method__;
      }

      invocation = [ controller, callMethod ].join(<span class="hljs-string">'#'</span>);

      controllerPromise(invocation, scenes)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
          <span class="hljs-keyword">if</span> (value.pipe !== <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">if</span> (value.md5) {
              res.set(<span class="hljs-string">'cache-control'</span>, <span class="hljs-string">'public, max-age=31536000'</span>);
              res.set(<span class="hljs-string">'etag'</span>, value.md5);
              res.set(<span class="hljs-string">'content-type'</span>, value.type || <span class="hljs-string">'application/octet-stream'</span>);
            }
            res.setHeader = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> value.pipe(res);
          }
          res.send(<span class="hljs-number">200</span>, value);
        })
        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
          <span class="hljs-keyword">if</span> (err &amp;&amp; err.statusCode === <span class="hljs-number">302</span>) {
            <span class="hljs-keyword">return</span> res.redirect(err.message);
          }
          <span class="hljs-keyword">if</span> (err &amp;&amp; err.statusCode === <span class="hljs-number">304</span>) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">304</span>).send(<span class="hljs-string">''</span>);
          }
          next(err);
        });
    };
  },

  minions: {},

  _codeError: codeError,
  _controllerPromise: controllerPromise,
  _parseDirective: parseDirective,
  _sceneFactory: sceneFactory,
  _scenePromise: scenePromise,
  _viewPromise: viewPromise
};
<span class="hljs-comment">/*jslint nomen: false*/</span>

leslie = <span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">Object</span>.create(proto);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
